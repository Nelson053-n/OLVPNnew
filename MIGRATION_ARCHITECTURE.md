# Архитектура миграции ключей

## Схема данных

### СТАРАЯ ВЕРСИЯ (deprecated)
```
┌─────────────────────────────┐
│      Таблица Users          │
├─────────────────────────────┤
│ account: 123456             │
│ account_name: "user1"       │
│ key: "ss://method:pass@..." │ ◄─── DEPRECATED
│ date: 2025-01-15 10:00      │
│ premium: True               │
│ region_server: "nederland"  │
│ promo_key: False            │
└─────────────────────────────┘
```

### НОВАЯ ВЕРСИЯ (актуальная)
```
┌─────────────────────────────┐
│      Таблица Users          │
├─────────────────────────────┤
│ account: 123456             │
│ account_name: "user1"       │
│ key: "ss://..." (ignore)    │ ◄─── НЕ используется
│ date: 2025-01-15 10:00      │
│ premium: True               │
│ region_server: "nederland"  │
│ promo_key: False            │
└─────────────────────────────┘
                │
                │ 1:N связь
                ▼
┌─────────────────────────────┐
│     Таблица UserKey         │ ◄─── НОВАЯ
├─────────────────────────────┤
│ id: "uuid-1234..."          │
│ account: 123456             │ ◄─── FK to Users
│ access_url: "ss://method:..│
│ outline_id: "15"            │
│ region_server: "nederland"  │
│ premium: True               │
│ date: 2025-01-15 10:00      │
│ promo: False                │
│ created_at: 2025-12-18      │
└─────────────────────────────┘
```

## Процесс миграции

```
┌─────────────────────────────────────────────────────────────┐
│                    КОМАНДА /migrate                         │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ 1. Сканирование всех записей Users с заполненным key       │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. Для каждого пользователя:                               │
│    ✓ Проверка наличия записей в UserKey                    │
│    ✓ Если есть → пропустить (уже мигрирован)              │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. Поиск ключа на Outline сервере (4 стратегии):          │
│    ① Users.key как outline_id (если число)                 │
│    ② Users.key как access_url → поиск по account           │
│    ③ Прямой поиск по account ID                            │
│    ④ Поиск по Users.id (UUID)                              │
└─────────────────────────────────────────────────────────────┘
                            │
                    ┌───────┴───────┐
                    ▼               ▼
        ┌──────────────────┐  ┌──────────────────┐
        │  Ключ найден     │  │ Ключ НЕ найден   │
        └──────────────────┘  └──────────────────┘
                    │               │
                    ▼               ▼
        ┌──────────────────┐  ┌──────────────────┐
        │ 4. Создание      │  │ 4. Логирование   │
        │    записи в      │  │    ошибки        │
        │    UserKey:      │  │    "не найден"   │
        │                  │  └──────────────────┘
        │  • access_url    │
        │  • outline_id    │
        │  • region_server │
        │  • premium       │
        │  • date          │
        │  • promo         │
        │  • created_at    │
        └──────────────────┘
                    │
                    ▼
        ┌──────────────────┐
        │ 5. Сохранение в  │
        │    БД (commit)   │
        └──────────────────┘
                    │
                    ▼
        ┌──────────────────┐
        │ 6. Статистика    │
        │    += 1          │
        └──────────────────┘
```

## Стратегии поиска ключа

### Стратегия 1: Поиск по outline_id
```python
if user.key.isdigit():
    outline_key = outline_manager.get_key_by_id(user.key)
    # Пример: user.key = "15" → outline_id = "15"
```

### Стратегия 2: Парсинг access_url
```python
if user.key.startswith('ss://'):
    outline_key = outline_manager.get_key_from_ol(str(user.account))
    # Пример: user.key = "ss://..." → ищем по account
```

### Стратегия 3: Поиск по account
```python
outline_key = outline_manager.get_key_from_ol(str(user.account))
# Стандартный подход новой версии
```

### Стратегия 4: Поиск по UUID
```python
outline_key = outline_manager.get_key_by_id(user.id)
# Фоллбэк для случаев когда использовался UUID
```

## Безопасность и откат

### Что НЕ удаляется
- ✅ Поле `Users.key` остается нетронутым
- ✅ Все записи `Users` сохраняются
- ✅ История платежей остается

### Откат миграции
```sql
-- Удалить все записи UserKey
DELETE FROM user_keys;

-- Восстановить БД из бэкапа
cp olvpnbot.db.backup olvpnbot.db
```

## Статистика миграции

```
┌──────────────────────────────────────────────┐
│          Отчет о миграции                   │
├──────────────────────────────────────────────┤
│ total_users                 │ Всего в БД     │
│ users_with_old_keys         │ Со старыми key │
│ successfully_migrated       │ Успешно        │
│ already_migrated            │ Уже были       │
│ failed_migrations           │ Ошибки         │
│ key_not_found_on_server     │ Не найдены     │
└──────────────────────────────────────────────┘
```

## Логирование

Все операции логируются с префиксом `[MIGRATION]`:

```log
[MIGRATION] Начало миграции. Всего пользователей: 150
[MIGRATION] Пользователь 123456 уже имеет ключи в новой системе
[MIGRATION] Успешно мигрирован ключ пользователя 234567 (outline_id: 15, region: nederland, premium: True, date: 2025-01-15 10:00:00)
[MIGRATION] Ключ пользователя 345678 не найден на nederland. Стратегии поиска: outline_id=678 → by_account=345678 → by_uuid=uuid-xxx
[MIGRATION] Миграция завершена. Статистика: {'total_users': 150, 'successfully_migrated': 148, ...}
```

## Совместимость

### Поддерживаемые форматы старых ключей

| Формат Users.key | Стратегия поиска |
|------------------|------------------|
| `"15"` (число) | Стратегия 1: get_key_by_id(15) |
| `"ss://method:pass@host:port"` | Стратегия 2: парсинг + поиск по account |
| `"uuid-1234-5678"` | Стратегия 4: get_key_by_id(uuid) |
| Пустая строка | Пропуск (users_with_old_keys не увеличивается) |

### Требования к серверу Outline

- ✅ Ключ должен существовать на сервере
- ✅ Регион сервера должен быть в `settings_api_outline.json`
- ✅ API сервера должен быть доступен

## Мультирегиональность

Миграция поддерживает несколько регионов:

```python
# Регион определяется из Users.region_server или дефолт 'nederland'
region_server = user.region_server if user.region_server else 'nederland'

# Для каждого пользователя используется его регион
outline_manager = OutlineManager(region_server=region_server)
```

Если у пользователя был ключ на сервере `germany`, он останется на `germany` после миграции.

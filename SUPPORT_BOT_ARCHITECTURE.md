# Архитектура и поток работы бота техподдержки

## Схема взаимодействия

```
┌─────────────────────────────────────────────────────────────────┐
│                      БОТ ТЕХПОДДЕРЖКИ                           │
│                     (support_bot.py)                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ Запуск
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  ИНИЦИАЛИЗАЦИЯ                                                   │
│  1. Загрузка .env переменных (SUPPORT_BOT_TOKEN, ADMIN_TLG)    │
│  2. Проверка наличия токена и ID администратора                 │
│  3. Создание Bot и Dispatcher объектов                          │
│  4. Регистрация обработчиков (handlers/routers)                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  ПОЛУЧЕНИЕ ИНФОРМАЦИИ О БОТЕ                                     │
│  bot.get_me() → username, id                                     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  УВЕДОМЛЕНИЕ АДМИНИСТРАТОРУ                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 🟢 Бот техподдержки запущен                              │   │
│  │                                                           │   │
│  │ 🤖 Бот: @your_support_bot                                │   │
│  │ 🆔 Bot ID: 123456789                                      │   │
│  │ ✅ Статус: Токен получен успешно                         │   │
│  │ 🔄 Состояние: Готов к приёму сообщений                  │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  ОСНОВНОЙ ЦИКЛ РАБОТЫ (Polling)                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ↓                     ↓                     ↓
┌──────────────┐    ┌──────────────────┐    ┌──────────────┐
│  /start      │    │  Текстовое       │    │  Медиа       │
│  команда     │    │  сообщение       │    │  файлы       │
└──────────────┘    └──────────────────┘    └──────────────┘
        │                     │                     │
        ↓                     ↓                     ↓
┌──────────────┐    ┌──────────────────┐    ┌──────────────┐
│ Отправка     │    │ Проверка: от     │    │ Уведомление  │
│ приветствия  │    │ пользователя     │    │ о           │
│              │    │ или админа?      │    │ неподдержке  │
└──────────────┘    └──────────────────┘    └──────────────┘
                              │
                ┌─────────────┴─────────────┐
                ↓                           ↓
    ┌───────────────────┐       ┌───────────────────┐
    │  От ПОЛЬЗОВАТЕЛЯ  │       │  От АДМИНИСТРАТОРА│
    └───────────────────┘       └───────────────────┘
                │                           │
                ↓                           ↓
    ┌───────────────────┐       ┌───────────────────┐
    │ 1. Сохранение     │       │ 1. Проверка:      │
    │    user_id,       │       │    это Reply?     │
    │    username,      │       │                   │
    │    full_name      │       └───────────────────┘
    │                   │                   │
    │ 2. Формирование   │       ┌───────────┴───────┐
    │    сообщения для  │       ↓                   ↓
    │    администратора │    ┌──────┐          ┌──────┐
    │                   │    │ ДА   │          │ НЕТ  │
    │ 3. Отправка       │    └──────┘          └──────┘
    │    администратору │       │                   │
    │                   │       ↓                   ↓
    │ 4. Подтверждение  │  ┌─────────┐      ┌──────────┐
    │    пользователю   │  │ Ответ   │      │ Подсказка│
    └───────────────────┘  │ через   │      │ как      │
                           │ Reply   │      │ ответить │
                           └─────────┘      └──────────┘
                                 │
                                 ↓
                    ┌────────────────────────┐
                    │ Извлечение user_id     │
                    │ из admin_messages{}    │
                    └────────────────────────┘
                                 │
                                 ↓
                    ┌────────────────────────┐
                    │ Отправка ответа        │
                    │ пользователю           │
                    └────────────────────────┘
                                 │
                                 ↓
                    ┌────────────────────────┐
                    │ Подтверждение          │
                    │ администратору         │
                    └────────────────────────┘
```

## Поток данных

### 1. Запуск бота

```
support_bot.py
    │
    ├─→ load_dotenv()
    │   ├─→ .env
    │   └─→ core/TEMP.env (fallback)
    │
    ├─→ Проверка SUPPORT_BOT_TOKEN
    │   └─→ Ошибка если отсутствует
    │
    ├─→ Проверка ADMIN_TLG
    │   └─→ Ошибка если отсутствует
    │
    ├─→ Bot(token=SUPPORT_BOT_TOKEN)
    │
    ├─→ bot.get_me()
    │   ├─→ Успех → Уведомление администратору
    │   └─→ Ошибка → Уведомление об ошибке
    │
    └─→ dp.start_polling()
```

### 2. Обработка сообщения пользователя

```
Пользователь отправляет сообщение
    │
    ↓
@router.message(F.text)
forward_to_admin()
    │
    ├─→ if from_user.id == ADMIN_ID:
    │   └─→ (см. блок "Ответ администратора")
    │
    ├─→ Извлечение данных:
    │   ├─→ user_id
    │   ├─→ username
    │   └─→ full_name
    │
    ├─→ Сохранение в user_mapping:
    │   user_mapping[user_id] = {
    │       'username': username,
    │       'full_name': full_name
    │   }
    │
    ├─→ Формирование admin_message_text
    │
    ├─→ sent_message = bot.send_message(ADMIN_ID, ...)
    │
    ├─→ Сохранение связи:
    │   admin_messages[sent_message.message_id] = user_id
    │   user_mapping[user_id]['last_message_id'] = sent_message.message_id
    │
    └─→ Подтверждение пользователю
```

### 3. Ответ администратора

```
Администратор отправляет Reply
    │
    ↓
@router.message(F.text)
forward_to_admin()
    │
    ├─→ if from_user.id == ADMIN_ID:
    │   │
    │   ├─→ if message.reply_to_message:
    │   │   │
    │   │   ├─→ if reply_to_message.message_id in admin_messages:
    │   │   │   │
    │   │   │   ├─→ user_id = admin_messages[message_id]
    │   │   │   │
    │   │   │   ├─→ bot.send_message(user_id, ответ)
    │   │   │   │
    │   │   │   └─→ Подтверждение администратору
    │   │   │
    │   │   └─→ else: "Используйте Reply или /reply"
    │   │
    │   └─→ return
    │
    └─→ (обработка сообщения пользователя)
```

### 4. Команда /reply

```
Администратор: /reply 123456789 Ваш ответ
    │
    ↓
@router.message(Command("reply"))
reply_to_user()
    │
    ├─→ Проверка: from_user.id == ADMIN_ID
    │   └─→ Нет → "У вас нет доступа"
    │
    ├─→ Парсинг команды:
    │   /reply USER_ID текст → ["/reply", "123456789", "Ваш ответ"]
    │
    ├─→ Проверка: len(parts) >= 3
    │   └─→ Нет → Инструкция по использованию
    │
    ├─→ user_id = int(parts[1])
    │   reply_text = parts[2]
    │
    ├─→ bot.send_message(user_id, reply_text)
    │
    └─→ Подтверждение администратору
```

## Структуры данных в памяти

### user_mapping

```python
{
    123456789: {  # user_id
        'username': 'ivan',
        'full_name': 'Иван Иванов',
        'last_message_id': 999  # ID сообщения в чате администратора
    },
    987654321: {
        'username': 'petr',
        'full_name': 'Пётр Петров',
        'last_message_id': 1000
    }
}
```

### admin_messages

```python
{
    999: 123456789,   # message_id: user_id
    1000: 987654321,  # администратор может ответить Reply на эти сообщения
    1001: 123456789
}
```

## Последовательность действий при старте

```
1. Загрузка переменных окружения
   ├─→ Попытка .env
   └─→ Fallback на core/TEMP.env

2. Валидация конфигурации
   ├─→ SUPPORT_BOT_TOKEN есть?
   └─→ ADMIN_TLG есть?

3. Инициализация объектов
   ├─→ Bot(token)
   ├─→ Dispatcher()
   └─→ Router()

4. Регистрация обработчиков
   ├─→ @router.message(Command("start"))
   ├─→ @router.message(F.text)
   ├─→ @router.message(Command("reply"))
   └─→ @router.message(F.photo | F.video | ...)

5. Получение информации о боте
   └─→ bot.get_me()

6. Уведомление администратору
   └─→ send_notification_to_admin()

7. Запуск polling
   └─→ dp.start_polling(bot)

8. При остановке
   └─→ Уведомление администратору
```

## Диаграмма последовательности

```
Пользователь          Support Bot          Telegram API          Администратор
    │                      │                     │                      │
    │────"Проблема"────────>│                     │                      │
    │                      │                     │                      │
    │                      │──get_user_info()───>│                      │
    │                      │<───user_data────────│                      │
    │                      │                     │                      │
    │                      │──────send_message()─┼─────────────────────>│
    │                      │     (пересылка)     │  "📩 Новое сообщение"│
    │                      │                     │  "👤 Иван Иванов"   │
    │<──"Получено"─────────│                     │  "💬 Проблема"       │
    │                      │                     │                      │
    │                      │                     │<──Reply "Решение"────│
    │                      │<──message───────────┼──────────────────────│
    │                      │                     │                      │
    │<──"📬 Ответ"─────────│                     │                      │
    │   "Решение"          │                     │                      │
    │                      │──────send_message()─┼─────────────────────>│
    │                      │  (подтверждение)    │  "✅ Ответ отправлен"│
```

## Обработка ошибок

```
Запуск
  │
  ├─→ Ошибка токена
  │   ├─→ RuntimeError
  │   ├─→ Логирование
  │   └─→ Выход
  │
  ├─→ Ошибка получения bot.get_me()
  │   ├─→ Уведомление администратору (попытка)
  │   ├─→ Логирование
  │   └─→ raise Exception
  │
  └─→ Ошибка отправки сообщения
      ├─→ Логирование
      ├─→ Уведомление пользователю/администратору
      └─→ Продолжение работы
```

---

**Дата:** 20 декабря 2025  
**Версия:** 1.0
